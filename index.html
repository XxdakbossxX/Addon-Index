<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Minecraft Bedrock Packs</title>
  <!-- Include Fuse.js for fuzzy searching the main query -->
  <script src="https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.min.js"></script>
  <style>
    /* Base styles with transitions */
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: #f9f9f9;
      color: #333;
      transition: background-color 0.3s, color 0.3s;
    }
    /* Dark mode: black background and white text */
    body.dark {
      background: #000;
      color: #fff;
    }
    /* Force common text elements to be white in dark mode */
    body.dark a,
    body.dark h1,
    body.dark h2,
    body.dark h3,
    body.dark h4,
    body.dark h5,
    body.dark h6,
    body.dark p,
    body.dark span,
    body.dark li,
    body.dark input,
    body.dark button {
      color: #fff;
    }
    /* Header styling */
    header {
      position: fixed;
      top: 0;
      width: 100%;
      background: #fff;
      border-bottom: 1px solid #ccc;
      z-index: 100;
      display: flex;
      align-items: center;
      padding: 10px 20px;
      box-sizing: border-box;
      transition: background-color 0.3s, border-color 0.3s;
    }
    body.dark header {
      background: #000;
      border-bottom: 1px solid #444;
    }
    /* Search bar styling */
    #search {
      flex-grow: 1;
      padding: 10px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 5px;
      transition: background-color 0.3s, color 0.3s;
    }
    body.dark #search {
      background: #222;
      border: 1px solid #555;
      color: #fff;
    }
    /* Toggle mode button */
    button#toggleMode {
      background: transparent;
      border: none;
      font-size: 20px;
      cursor: pointer;
      margin-left: 10px;
      color: inherit;
    }
    /* Tab bar styling */
    #tabBar {
      display: flex;
      border-bottom: 1px solid #ccc;
      margin-top: 80px; /* leave room for header */
    }
    #tabBar button {
      flex: 1;
      padding: 10px;
      background: transparent;
      border: none;
      font-size: 16px;
      cursor: pointer;
      transition: border-bottom 0.3s, font-weight 0.3s;
    }
    #tabBar button.active {
      border-bottom: 2px solid #28a745;
      font-weight: bold;
    }
    body.dark #tabBar button.active {
      border-bottom-color: #66bfff;
    }
    /* Main content spacing */
    main {
      padding: 10px 20px 60px;
    }
    /* Pack card styling */
    .addon {
      background: #fff;
      border: 1px solid #ccc;
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 5px;
      box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      transition: background-color 0.3s, border-color 0.3s;
    }
    body.dark .addon {
      background: #111;
      border: 1px solid #444;
    }
    .addon img {
      max-width: 150px;
      margin-right: 20px;
      border-radius: 5px;
    }
    .addon-content {
      flex: 1;
    }
    .addon-header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
    }
    .addon-header h2 {
      margin: 0;
    }
    .version-info {
      font-size: 0.9em;
      color: #666;
      margin-top: 5px;
      transition: color 0.3s;
    }
    body.dark .version-info {
      color: #aaa;
    }
    /* Download button styling */
    .download-btn {
      display: inline-block;
      text-decoration: none;
      padding: 10px 15px;
      margin-top: 10px;
      border-radius: 5px;
      background: #28a745;
      color: #fff;
      font-size: 14px;
      transition: background-color 0.3s;
    }
    .download-btn:hover {
      background: #218838;
    }
    /* Direct Install button styling */
    .direct-install-btn {
      display: inline-block;
      text-decoration: none;
      padding: 10px 15px;
      margin-top: 10px;
      margin-left: 10px;
      border-radius: 5px;
      background: #007bff;
      color: #fff;
      font-size: 14px;
      transition: background-color 0.3s;
    }
    .direct-install-btn:hover {
      background: #0056b3;
    }
    /* Footer styling */
    footer {
      text-align: center;
      padding: 15px 0;
      border-top: 1px solid #ccc;
      background: #f9f9f9;
      margin-top: 20px;
      transition: background-color 0.3s, border-color 0.3s;
    }
    body.dark footer {
      background: #000;
      border-top: 1px solid #444;
    }
  </style>
</head>
<body>
  <!-- Fixed header with search bar and theme toggle -->
  <header id="header">
    <input type="text" id="search" placeholder="Search packs..." onkeyup="handleSearchInput()" />
    <button id="toggleMode" onclick="toggleDarkMode()"></button>
  </header>
  
  <!-- Main content area -->
  <main>
    <!-- Tab bar -->
    <div id="tabBar">
      <button id="tabAddons" class="active" onclick="setTab('addons')">Addons</button>
      <button id="tabWorlds" onclick="setTab('worlds')">Worlds</button>
    </div>
    <!-- Container for search results -->
    <div id="addonsList"></div>
  </main>
  
  <!-- Footer -->
  <footer>
    <span id="counter">Site Views: Loading...</span>
  </footer>
  
  <script>
    let addons = [];
    let fuse = null;
    let currentTab = 'addons'; // Default tab

    // Emoji icons for the theme toggle.
    const sunIcon = '☀';
    const moonIcon = '☾';

    // Update the toggle button's icon.
    function setModeButton() {
      const toggleButton = document.getElementById('toggleMode');
      toggleButton.innerHTML = document.body.classList.contains('dark') ? moonIcon : sunIcon;
    }

    // Toggle dark mode.
    function toggleDarkMode() {
      document.body.classList.toggle('dark');
      localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light');
      setModeButton();
      updateTabStyles();
    }

    // Update the URL query parameter "q".
    function updateQueryParam(searchTerm) {
      const base = window.location.protocol + "//" + window.location.host + window.location.pathname;
      const newUrl = searchTerm ? `${base}?q=${encodeURIComponent(searchTerm)}` : base;
      window.history.replaceState({ path: newUrl }, '', newUrl);
    }

    // Handle search input.
    function handleSearchInput() {
      const query = document.getElementById('search').value;
      updateQueryParam(query.trim());
      filterAddons();
    }

    // Set current tab.
    function setTab(tab) {
      currentTab = tab;
      updateTabStyles();
      filterAddons();
    }

    // Update active tab styling.
    function updateTabStyles() {
      document.getElementById('tabAddons').classList.toggle('active', currentTab === 'addons');
      document.getElementById('tabWorlds').classList.toggle('active', currentTab === 'worlds');
    }

    // Filter packs using Fuse.js and current tab.
    function filterAddons() {
      const query = document.getElementById('search').value;
      let results = [];
      if (!query || !fuse) {
        results = addons;
      } else {
        const fuseResult = fuse.search(query);
        results = fuseResult.map(r => r.item);
      }
      // Only include items whose "type" matches the current tab.
      results = results.filter(item => item.type === currentTab);
      displayAddons(results);
    }

    // Render pack cards.
    function displayAddons(itemList) {
      const container = document.getElementById('addonsList');
      container.innerHTML = '';
      if (itemList.length === 0) {
        const query = document.getElementById('search').value.trim();
        if (query !== "") {
          const slugParam = currentTab === 'worlds' ? 'maps' : 'addons';
          container.innerHTML = `<p>No items match your search.</p>
            <p><a href="https://mcpedl.com/?s=${encodeURIComponent(query)}&type=category&slug=${slugParam}" target="_blank">
              Search MCPEDL for "${query}"</a></p>`;
        } else {
          container.innerHTML = '<p>No packs found.</p>';
        }
        return;
      }
      itemList.forEach(item => {
        const div = document.createElement('div');
        div.className = 'addon';
        // Compute the absolute URL based on the current base URL (removing index.html if present)
        const absoluteURL = getBaseUrl() + item.directory;
        // Determine which protocol parameter to use based on file extension:
        let protocolParameter = "importaddon"; // default
        const fileLower = item.directory.toLowerCase();
        if (fileLower.endsWith(".mcpack")) {
          protocolParameter = "importpack";
        } else if (fileLower.endsWith(".mcaddon")) {
          protocolParameter = "importaddon";
        }
        // Build the direct install URL.
        const directInstallLink = "minecraft://?" + protocolParameter + "=" + encodeURIComponent(absoluteURL);
        div.innerHTML = `
          <img src="${item.displayImage}" alt="${item.displayName} Banner" />
          <div class="addon-content">
            <div class="addon-header">
              <h2>${item.displayName}</h2>
            </div>
            <div class="version-info">
              Game Version: ${item.gameversion} | Pack Version: ${item.packversion} | Author: ${item.author}
            </div>
            <p>${item.description}</p>
            <a class="download-btn" href="${item.directory}" download>Download</a>
            <a class="direct-install-btn" href="${directInstallLink}" target="_blank">Direct Install</a>
          </div>
        `;
        container.appendChild(div);
      });
    }

    // Helper: Get base URL (remove "index.html" if present and ensure trailing slash).
    function getBaseUrl() {
      const urlObj = new URL(window.location.href);
      let path = urlObj.pathname;
      if (path.endsWith("index.html")) {
        path = path.substring(0, path.length - "index.html".length);
      }
      if (!path.endsWith("/")) {
        path += "/";
      }
      return window.location.origin + path;
    }

    // Pre-fill the search box from the "q" URL parameter.
    function checkURLParameter() {
      const params = new URLSearchParams(window.location.search);
      const searchTerm = params.get('q');
      if (searchTerm) {
        document.getElementById('search').value = searchTerm;
      }
    }

    // Fetch the packs JSON data and initialize Fuse.js.
    async function loadAddons() {
      try {
        const url = 'addons.json?v=' + new Date().getTime();
        const response = await fetch(url, { cache: 'no-store' });
        if (!response.ok) {
          throw new Error('HTTP error! status: ' + response.status);
        }
        addons = await response.json();
        fuse = new Fuse(addons, {
          keys: ['displayName', 'description', 'author', 'gameversion', 'packversion'],
          threshold: 0.4
        });
        filterAddons();
      } catch (error) {
        console.error('Error loading packs:', error);
        document.getElementById('addonsList').innerHTML = '<p>Error loading packs data.</p>';
      }
    }

    // Load a site view counter via CountAPI.
    async function loadSiteViews() {
      try {
        const response = await fetch('https://api.countapi.xyz/hit/minecraft-bedrock-addons/visits');
        const data = await response.json();
        document.getElementById('counter').innerText = 'Site Views: ' + data.value;
      } catch (error) {
        console.error('Error loading site views:', error);
        document.getElementById('counter').innerText = 'Site Views: Error';
      }
    }
    
    // On page load: apply saved theme, load packs, pre-fill search, and load site views.
    window.onload = async function() {
      if (localStorage.getItem('theme') === 'dark') {
        document.body.classList.add('dark');
      }
      setModeButton();
      await loadAddons();
      checkURLParameter();
      filterAddons();
      loadSiteViews();
    }
  </script>
</body>
</html>
